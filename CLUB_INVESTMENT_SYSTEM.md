# 部活投資システム実装仕様書

## 📋 概要

部活に投資できるシステムを実装します。部活作成時の10,000ロメコインを出資金とし、ユーザーが部活に投資できます。部活のアクティブポイントに比例して株価が変動します。

---

## 💰 基本概念

### 出資金（初期資本）
- **部活作成時の10,000ロメコイン**を出資金とする
- この10,000ロメコインが初期の「部活株式」の総額となる
- 初期株価は **1ロメコイン = 1株** とする

### 株式の仕組み
- 部活には**発行済み株式数**が存在する
- ユーザーは部活に投資して**株式を購入**できる
- 部活のアクティブポイントに応じて**株価が変動**する
- ユーザーは保有株式を**売却**できる

---

## 📊 株価計算式

### 基本計算式

```
現在の株価 = (出資金 + 投資総額) × (現在のアクティブポイント / 基準アクティブポイント) / 発行済み株式数
```

### 基準アクティブポイントの設定

現在のアクティブポイント分布を基準に設定：

| 順位 | アクティブポイント | 用途 |
|:---|:---|:---|
| 1位 | 20,000 | 基準点（初期株価の2倍相当） |
| 2位 | 13,000 | - |
| 3-4位 | 5,000以上 | - |
| 5-7位 | 1,000以上 | - |
| 8-13位 | 100以上 | - |
| 14位以降 | 100未満 | - |

**基準アクティブポイント: 10,000ポイント**（1位の50%）

### 株価変動の例

- **アクティブポイント = 20,000**（1位）: 株価 = 2.0倍
- **アクティブポイント = 10,000**（基準）: 株価 = 1.0倍
- **アクティブポイント = 5,000**（3-4位）: 株価 = 0.5倍
- **アクティブポイント = 1,000**（5-7位）: 株価 = 0.1倍
- **アクティブポイント = 100**（8-13位）: 株価 = 0.01倍
- **アクティブポイント = 50**（14位以降）: 株価 = 0.005倍

---

## 🔄 投資・売却の仕組み

### 投資（株式購入）

1. **ユーザーが投資額を指定**
   - 例: 1,000ロメコイン投資
   
2. **現在の株価を計算**
   ```
   現在の株価 = (出資金 + 投資総額) × (現在のアクティブポイント / 10,000) / 発行済み株式数
   ```

3. **購入可能な株式数を計算**
   ```
   購入株式数 = 投資額 / 現在の株価
   ```

4. **ロメコインを減額し、株式を発行**
   - ユーザーのロメコインを減額
   - 部活の投資総額に追加
   - 発行済み株式数を増加
   - ユーザーの保有株式数を記録

### 売却（株式売却）

1. **ユーザーが売却株式数を指定**
   - 例: 100株売却

2. **現在の株価を計算**（投資時と同じ式）

3. **売却金額を計算**
   ```
   売却金額 = 売却株式数 × 現在の株価
   ```

4. **株式を回収し、ロメコインを返却**
   - ユーザーの保有株式数を減少
   - 発行済み株式数を減少
   - 部活の投資総額から減額
   - ユーザーのロメコインを増額

---

## 📁 データ構造

### 部活投資データ（`club_investment_data.json`）

```json
{
  "club_channel_id": {
    "initialCapital": 10000,           // 出資金（部活作成時の10,000ロメコイン）
    "totalInvestment": 5000,          // 投資総額（ユーザーからの投資累計）
    "totalShares": 15000,             // 発行済み株式数（初期10,000 + 投資による増加）
    "baseActivityPoint": 10000,       // 基準アクティブポイント
    "investors": {                     // 投資者一覧
      "user_id_1": {
        "shares": 5000,                // 保有株式数
        "totalInvested": 5000,         // 累計投資額
        "averagePrice": 1.0            // 平均取得価格
      },
      "user_id_2": {
        "shares": 3000,
        "totalInvested": 3000,
        "averagePrice": 1.0
      }
    },
    "createdAt": 1234567890,          // 部活作成日時
    "lastUpdated": 1234567890          // 最終更新日時
  }
}
```

---

## 🎮 コマンド仕様

### `/club_invest info [部活チャンネル]`
- **機能**: 部活の投資情報を表示
- **表示内容**:
  - 現在の株価
  - 発行済み株式数
  - 投資総額
  - 現在のアクティブポイント
  - 株価変動率（基準点からの変動）

### `/club_invest buy [部活チャンネル] [投資額]`
- **機能**: 部活に投資（株式購入）
- **パラメータ**:
  - `部活チャンネル`: 投資する部活チャンネル（オプション、未指定時は現在のチャンネル）
  - `投資額`: 投資するロメコイン額（1以上）
- **処理**:
  1. 現在の株価を計算
  2. 購入可能な株式数を計算
  3. ロメコインを減額
  4. 株式を発行
  5. 投資情報を更新

### `/club_invest sell [部活チャンネル] [株式数]`
- **機能**: 保有株式を売却
- **パラメータ**:
  - `部活チャンネル`: 売却する部活チャンネル（オプション）
  - `株式数`: 売却する株式数（1以上、保有株式数以下）
- **処理**:
  1. 現在の株価を計算
  2. 売却金額を計算
  3. 株式を回収
  4. ロメコインを増額
  5. 投資情報を更新

### `/club_invest portfolio`
- **機能**: 自分の投資ポートフォリオを表示
- **表示内容**:
  - 投資している部活一覧
  - 各部活の保有株式数
  - 現在の評価額
  - 損益（平均取得価格との比較）

---

## 🔌 ヒサメbot連携API仕様

### 1. 部活アクティブポイント取得API

**エンドポイント**: `GET /api/club/activity/:channelId`

**リクエスト**:
```
GET /api/club/activity/{channelId}
Headers:
  x-api-token: {API_TOKEN}
```

**レスポンス**:
```json
{
  "channelId": "1234567890123456789",
  "activityPoint": 15000,
  "rank": 2,
  "lastUpdated": 1234567890
}
```

**説明**:
- `activityPoint`: 部活の現在のアクティブポイント
- `rank`: 部活ランキング順位（1位が最高）
- `lastUpdated`: 最終更新日時（Unix timestamp）

### 2. 部活一覧取得API（オプション）

**エンドポイント**: `GET /api/club/list`

**リクエスト**:
```
GET /api/club/list
Headers:
  x-api-token: {API_TOKEN}
```

**レスポンス**:
```json
{
  "clubs": [
    {
      "channelId": "1234567890123456789",
      "channelName": "ゲーム部",
      "activityPoint": 20000,
      "rank": 1
    },
    {
      "channelId": "9876543210987654321",
      "channelName": "音楽部",
      "activityPoint": 13000,
      "rank": 2
    }
  ]
}
```

---

## 🔄 株価更新タイミング

### リアルタイム更新（推奨）
- アクティブポイントが変動するたびに株価を再計算
- 投資・売却時に最新のアクティブポイントを使用

### 定期更新（代替案）
- 1時間ごと、または1日ごとに株価を更新
- アクティブポイントの取得頻度に依存

---

## 💻 実装時の注意点

### 1. 株価計算の精度
- 小数点以下の処理（株式数は整数、株価は小数）
- 端数処理（切り捨て、切り上げ、四捨五入）

### 2. 同時投資の処理
- 複数ユーザーが同時に投資した場合の競合処理
- トランザクション管理

### 3. アクティブポイントの取得
- ヒサメbotからアクティブポイントを取得する方法
- 取得失敗時の処理（前回の値を保持、エラー表示など）

### 4. データの永続化
- 投資データの保存（JSONファイル、データベース）
- バックアップ処理

### 5. エラーハンドリング
- ロメコイン不足時の処理
- 株式数不足時の処理
- API呼び出し失敗時の処理

---

## 📝 ヒサメbotに伝えるべき情報

### 必須情報

1. **APIエンドポイント**
   - `GET /api/club/activity/:channelId`
   - 部活チャンネルIDを指定してアクティブポイントを取得

2. **API認証**
   - ヘッダーに `x-api-token: {API_TOKEN}` を設定
   - `API_TOKEN` は環境変数で設定

3. **レスポンス形式**
   - JSON形式
   - `activityPoint`: 数値（整数）
   - `rank`: 数値（1位が最高）
   - `lastUpdated`: Unix timestamp

4. **更新頻度**
   - リアルタイム更新が理想
   - 最低でも1時間ごとに更新
   - 部活ランキング更新時に同時に更新

### オプション情報

1. **部活一覧取得API**
   - 全部活のアクティブポイントを一度に取得できると便利
   - `GET /api/club/list`

2. **部活チャンネルIDの取得方法**
   - DiscordチャンネルIDをそのまま使用
   - 部活カテゴリ内のチャンネルを対象

---

## 🎯 実装優先順位

### Phase 1: 基本機能
1. データ構造の定義
2. 株価計算ロジック
3. 投資（購入）機能
4. 売却機能
5. 情報表示機能

### Phase 2: API連携
1. ヒサメbot API連携
2. アクティブポイント取得
3. 株価自動更新

### Phase 3: 拡張機能
1. ポートフォリオ表示
2. 投資履歴
3. 損益計算
4. 投資ランキング

---

## 📊 計算例

### 例1: 部活作成時
- **出資金**: 10,000ロメコイン
- **発行済み株式数**: 10,000株
- **基準アクティブポイント**: 10,000
- **現在のアクティブポイント**: 10,000（基準点）
- **株価**: (10,000 + 0) × (10,000 / 10,000) / 10,000 = **1.0ロメコイン/株**

### 例2: 投資後、アクティブポイント上昇
- **出資金**: 10,000ロメコイン
- **投資総額**: 5,000ロメコイン（ユーザーAが投資）
- **発行済み株式数**: 15,000株（10,000 + 5,000）
- **現在のアクティブポイント**: 20,000（1位）
- **株価**: (10,000 + 5,000) × (20,000 / 10,000) / 15,000 = **2.0ロメコイン/株**
- **ユーザーAの評価額**: 5,000株 × 2.0 = **10,000ロメコイン**（2倍の利益）

### 例3: アクティブポイント下降
- **出資金**: 10,000ロメコイン
- **投資総額**: 5,000ロメコイン
- **発行済み株式数**: 15,000株
- **現在のアクティブポイント**: 5,000（3-4位）
- **株価**: (10,000 + 5,000) × (5,000 / 10,000) / 15,000 = **0.5ロメコイン/株**
- **ユーザーAの評価額**: 5,000株 × 0.5 = **2,500ロメコイン**（50%の損失）

---

## ⚠️ 注意事項

1. **出資金の扱い**
   - 部活作成時の10,000ロメコインは出資金として扱う
   - この10,000ロメコインは部活の「資本」として機能
   - 部活が廃部になった場合の処理を検討する必要がある

2. **株式数の制限**
   - 発行済み株式数に上限を設けるか検討
   - 無限に株式を発行すると株価が下がり続ける可能性

3. **アクティブポイントの変動**
   - アクティブポイントが0になった場合の処理
   - 負の値にならないようにする

4. **投資のリスク**
   - ユーザーに投資リスクを明示
   - アクティブポイントが下がると損失が発生することを説明

---

## 🔗 関連ファイル

- `features/clubInvestment.js`: 部活投資機能のメイン実装
- `lib/clubInvestment.js`: 株価計算ロジック
- `club_investment_data.json`: 投資データの保存先
- `constants.js`: 部活カテゴリIDなどの設定

