# 銀行・借金システム詳細

## 📋 目次

1. [銀行機能（/bank）](#銀行機能bank)
2. [借金機能（/loan）](#借金機能loan)
3. [利子計算](#利子計算)
4. [データ管理](#データ管理)

---

## 銀行機能（/bank）

### 概要
黒須銀行に預金することで、利子がつきます。預金額はランキングにも含まれます。

### コマンド
```
/bank [サブコマンド]
```

### サブコマンド

#### `deposit` - 預金
**説明**: ロメコインを銀行に預金します

**オプション**:
- `amount` (必須): 預金額

**機能**:
- 預金に利子がつく（年利2%相当、1時間ごとに計算）
- ゲーム時に自動的に引き出される（残高が不足している場合）
- ランキングに預金額も含まれる

**制限**:
- 世代ロール必須
- 残高が不足している場合はエラー

**利子率**: 年利2%相当（1時間ごとに約0.000228%）

---

#### `withdraw` - 引き出し
**説明**: 銀行からロメコインを引き出します

**オプション**:
- `amount` (必須): 引き出し額

**制限**:
- 世代ロール必須
- 預金額が不足している場合はエラー

---

#### `info` - 預金情報確認
**説明**: 預金情報を確認します

**表示内容**:
- 現在の預金額
- 所持ロメコイン
- 合計残高

---

## 借金機能（/loan）

### 概要
他のユーザーから借金を借りたり、貸したりできます。借金には利子がつきます。

### コマンド
```
/loan [サブコマンド]
```

### サブコマンド

#### `request` - 借金を貸す
**説明**: 他のユーザーに借金を貸します

**オプション**:
- `borrower` (必須): 借り手
- `amount` (必須): 貸付額
- `days` (任意): 返済期限（日数、デフォルト: 7日）

**処理フロー**:
1. 貸し手が借金リクエストを送信
2. 借り手に承認リクエストが送信される
3. 借り手が承認すると借金が成立
4. 借り手のロメコイン残高が増加
5. 借金には利子がつく（1時間ごとに1.5%）
6. 期限切れになると自動的に返済処理

**制限**:
- 世代ロール必須
- 残高が不足している場合はエラー
- 自分自身には貸せない
- Botには貸せない

**利子率**: 1時間ごとに1.5%

---

#### `repay` - 借金を返済
**説明**: 借金を返済します

**オプション**:
- `lender` (必須): 貸し手

**処理フロー**:
1. 借り手が返済を実行
2. 借金の元本 + 利子を計算
3. 借り手のロメコイン残高から返済額を減額
4. 貸し手のロメコイン残高に返済額を増額
5. 借金データを削除

**制限**:
- 世代ロール必須
- 残高が不足している場合はエラー
- 借金が存在しない場合はエラー

---

#### `info` - 借金情報確認
**説明**: 借金情報を確認します

**表示内容**:
- 借りている借金一覧
  - 貸し手
  - 借金額
  - 利子
  - 返済期限
- 貸している借金一覧
  - 借り手
  - 貸付額
  - 利子
  - 返済期限

---

## 利子計算

### 銀行預金の利子

**利子率**: 年利2%相当（1時間ごとに約0.000228%）

**計算式**: `利子 = 元本 × (1 + 利子率)^時間数 - 元本`

**計算間隔**: 1時間ごと（`INTEREST_INTERVAL_MS = 60 * 60 * 1000`）

**例**:
- 預金額: 10,000コイン
- 1時間後の利子: 約2.28コイン
- 24時間後の利子: 約54.72コイン
- 1週間後の利子: 約383.04コイン

---

### 借金の利子

**利子率**: 1時間ごとに1.5%

**計算式**: `利子 = 元本 × (1 + 利子率)^時間数 - 元本`

**計算間隔**: 1時間ごと

**例**:
- 借金額: 10,000コイン
- 1時間後の利子: 150コイン
- 24時間後の利子: 約3,600コイン
- 1週間後の利子: 約25,200コイン

**注意**: 借金の利子は非常に高く、早期返済を推奨します。

---

## 自動返済処理

### 期限切れ借金の自動返済

**処理タイミング**: 1時間ごと

**処理内容**:
1. すべての借金をチェック
2. 返済期限を過ぎた借金を検出
3. 借り手のロメコイン残高から返済額を減額
4. 貸し手のロメコイン残高に返済額を増額
5. 借金データを削除

**注意**: 残高が不足している場合でも強制的に返済処理が実行されます（預金から自動引き出しが使用される場合があります）。

---

## データ管理

### 銀行データ

**ファイル名**: `bank_data.json`

**データ構造**:
```json
{
  "userId": {
    "deposit": 預金額（数値）,
    "lastInterestTime": 最後に利子計算した時刻（タイムスタンプ）
  }
}
```

---

### 借金データ

**ファイル名**: `loan_data.json`

**データ構造**:
```json
{
  "lenderId_borrowerId": {
    "lenderId": 貸し手のID,
    "borrowerId": 借り手のID,
    "amount": 借金額（数値）,
    "interest": 利子（数値）,
    "createdAt": 作成時刻（タイムスタンプ）,
    "dueDate": 返済期限（タイムスタンプ）
  }
}
```

**Notion連携**: Discord IDとNotion名の両方で管理可能。

---

## 関連ドキュメント

- [COMMANDS_OVERVIEW.md](./COMMANDS_OVERVIEW.md) - コマンド一覧
- [ROMECOIN_SYSTEM.md](./ROMECOIN_SYSTEM.md) - ロメコインシステムの詳細

