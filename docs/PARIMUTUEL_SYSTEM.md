# パリミュチュエルシステム詳細

## 📋 目次

1. [概要](#概要)
2. [レース作成（管理者専用）](#レース作成管理者専用)
3. [レース一覧](#レース一覧)
4. [レース情報とオッズ](#レース情報とオッズ)
5. [賭け方](#賭け方)
6. [賭けタイプ](#賭けタイプ)
7. [オッズ計算](#オッズ計算)
8. [結果確定と配当](#結果確定と配当)
9. [自分の賭け確認](#自分の賭け確認)

---

## 概要

パリミュチュエル方式のレース賭け機能です。運営がレースを作成し、ユーザーが候補者に賭けることができます。

**コマンド**: `/race`

**手数料**: なし（以前は25%の手数料があったが削除済み）

---

## レース作成（管理者専用）

### コマンド
```
/race create [race_id] [name] [candidates]
```

### オプション
- `race_id` (必須): レースID（一意の識別子）
- `name` (必須): レース名
- `candidates` (必須): 候補者名（カンマ区切り、例: 候補者1,候補者2,候補者3）

### 制限
- 管理者ロール必須
- レースIDは重複不可
- 候補者は2名以上20名まで
- 候補者名に重複は不可

### 例
```
/race create race_001 "第1回大会" "候補者A,候補者B,候補者C"
```

---

## レース一覧

### コマンド
```
/race list
```

### 表示内容
- レースID
- レース名
- 候補者
- ステータス（open, closed, finished）

---

## レース情報とオッズ

### コマンド
```
/race info [race_id]
```

### 表示内容
- レース名
- 候補者一覧
- 各賭けタイプのオッズ
- 総賭け金

### オッズ表示例
```
単勝オッズ:
候補者A: 2.5倍
候補者B: 3.0倍
候補者C: 1.8倍

複勝オッズ:
候補者A: 1.2倍
候補者B: 1.5倍
候補者C: 1.1倍
...
```

---

## 賭け方

### コマンド
```
/race bet [race_id] [bet_type] [amount] [selection1] [selection2] [selection3]
```

### オプション
- `race_id` (必須): レースID
- `bet_type` (必須): 賭けの種類（単勝、複勝、ワイド、三連複、三連単）
- `amount` (必須): 賭け金（最低100ロメコイン）
- `selection1` (必須): 選択1
- `selection2` (任意): 選択2（ワイド、三連複、三連単の場合）
- `selection3` (任意): 選択3（三連複、三連単の場合）

### 制限
- 世代ロール必須
- 最低賭け金: 100コイン
- 残高が不足している場合はエラー
- レースが締め切られている場合はエラー

---

## 賭けタイプ

### 1. 単勝（tansho）
**説明**: 1着を予想します

**選択数**: 1名

**例**:
```
/race bet race_001 tansho 1000 "候補者A"
```

---

### 2. 複勝（fukusho）
**説明**: 3着以内を予想します

**選択数**: 1名

**例**:
```
/race bet race_001 fukusho 1000 "候補者A"
```

---

### 3. ワイド（wide）
**説明**: 3着以内の2名を予想します（順番は問わない）

**選択数**: 2名

**例**:
```
/race bet race_001 wide 1000 "候補者A" "候補者B"
```

---

### 4. 三連複（sanrenpuku）
**説明**: 3着以内の順番を問わず3名を予想します

**選択数**: 3名

**例**:
```
/race bet race_001 sanrenpuku 1000 "候補者A" "候補者B" "候補者C"
```

---

### 5. 三連単（sanrentan）
**説明**: 3着以内の順番通り3名を予想します

**選択数**: 3名

**例**:
```
/race bet race_001 sanrentan 1000 "候補者A" "候補者B" "候補者C"
```

---

## オッズ計算

### パリミュチュエル方式

**計算式**:
```
オッズ = 総賭け金 / 該当する賭けの総額
```

**例**:
- 総賭け金: 10,000コイン
- 候補者Aの単勝賭け: 4,000コイン
- 候補者Aの単勝オッズ: 10,000 / 4,000 = 2.5倍

---

### 動的オッズ

オッズは賭けが入るたびに動的に更新されます。

**注意**: レースが締め切られるまでオッズは変動します。

---

## 結果確定と配当

### レース締め切り（管理者専用）

**コマンド**:
```
/race close [race_id]
```

**処理**:
- レースの受付を締め切る
- ステータスが`closed`に変更される
- これ以降、新しい賭けは受け付けられない

---

### 結果確定（管理者専用）

**コマンド**:
```
/race result [race_id] [result]
```

**オプション**:
- `race_id` (必須): レースID
- `result` (必須): 結果（カンマ区切り、順番通り、例: 1着,2着,3着）

**処理**:
1. 結果を確定
2. 各賭けタイプの配当を計算
3. 勝者に配当を支払う
4. ステータスが`finished`に変更される

**配当計算**:
```
配当 = 賭け金 × オッズ
```

**例**:
- 賭け金: 1,000コイン
- オッズ: 2.5倍
- 配当: 1,000 × 2.5 = 2,500コイン

---

## 自分の賭け確認

### コマンド
```
/race mybets [race_id]
```

### オプション
- `race_id` (任意): レースID（未指定時は全レース）

### 表示内容
- レースID
- レース名
- 賭けタイプ
- 選択した候補者
- 賭け金
- オッズ
- ステータス（未確定、的中、外れ）

---

## データ管理

### パリミュチュエルデータ

**ファイル名**: `parimutuel_data.json`

**データ構造**:
```json
{
  "races": {
    "race_id": {
      "id": "race_id",
      "name": "レース名",
      "candidates": ["候補者1", "候補者2", "..."],
      "creatorId": "作成者ID",
      "status": "open|closed|finished",
      "createdAt": 作成時刻（タイムスタンプ）,
      "finishedAt": 終了時刻（タイムスタンプ）,
      "result": ["1着", "2着", "3着"]
    }
  },
  "bets": {
    "bet_id": {
      "raceId": "race_id",
      "userId": "ユーザーID",
      "betType": "tansho|fukusho|wide|sanrenpuku|sanrentan",
      "amount": 賭け金（数値）,
      "selections": ["選択1", "選択2", "選択3"],
      "odds": オッズ（数値）,
      "payout": 配当（数値、未確定時はnull）,
      "createdAt": 作成時刻（タイムスタンプ）
    }
  }
}
```

---

## 関連ドキュメント

- [COMMANDS_OVERVIEW.md](./COMMANDS_OVERVIEW.md) - コマンド一覧
- [ROMECOIN_SYSTEM.md](./ROMECOIN_SYSTEM.md) - ロメコインシステムの詳細

