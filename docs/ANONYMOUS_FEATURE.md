# /anonymous コマンド機能まとめ

## 概要
`/anonymous`コマンドは、Discordサーバーで匿名メッセージを送信する機能です。Webhookを使用してBot名義でメッセージを投稿し、ユーザーの匿名性を保ちながらも、運営による特定が可能な仕組みになっています。

## 主な機能

### 1. 匿名メッセージの送信
- Webhookを使用して「CROSSROID Anonymous」という名前でメッセージを送信
- Botのアバターを使用
- ユーザーの実際の名前やアバターは表示されない

### 2. 匿名IDシステム
各ユーザーには以下の情報が生成されます：

#### 日替わりID（Daily ID）
- ユーザーIDと日付に基づいて生成される英数字ID
- 毎日変更される
- 形式: `[a-z0-9]+`

#### Wacchoi（ﾜｯﾁｮｲ）
- ユーザーIDと日付に基づいて生成される識別子
- 形式: `[a-z0-9-]+`
- メッセージのユーザー名に表示される

#### 匿名名（裏名）
- 日替わりIDから生成される「ダサい名前」
- エリートロール保有者は「高貴な名前」が生成される
- プレフィックス + サフィックスの組み合わせ

**通常ユーザーの名前例:**
- 弱そうなスライム
- 陰湿なゴブリン
- 間の抜けた囚人
など

**エリートユーザーの名前例:**
- 高貴な貴族
- 選ばれし騎士
- 天才的な英雄
など

### 3. クールダウンシステム
使用回数に応じて段階的にクールダウンが増加します：

| 使用回数 | クールダウン時間 |
|---------|----------------|
| 1-3回目  | 20秒           |
| 4-10回目 | 1分            |
| 11-20回目| 5分            |
| 21回目以降| 30分          |

**エリートロール特典:**
- エリートロール（`ELITE_ROLE_ID`）を保有している場合、クールダウン時間が半分になります

### 4. メッセージ制限
以下の制限が設けられています：
- **改行不可**: メッセージに改行を含めることはできません
- **文字数制限**: 最大256文字まで
- **メンション防止**: `@everyone`、`@here`、ロールメンションは自動的に無効化されます

### 5. 表示形式
匿名メッセージのユーザー名は以下の形式で表示されます：
```
[匿名名] ID:[日替わりID] (ﾜｯﾁｮｲ [Wacchoi])
```

例：
```
弱そうなスライム ID:abc123 (ﾜｯﾁｮｲ xyz-789)
```

### 6. 運営による特定機能
運営専用のコンテキストメニューコマンド「匿名開示 (運営専用)」により、匿名メッセージからユーザーを特定することができます。

特定方法：
- 日替わりIDまたはWacchoiを解析
- サーバーメンバー全員のIDと照合
- 一致するユーザーを特定

## 技術的な実装

### 使用されている関数
- `generateWacchoi(userId)`: Wacchoiを生成
- `generateDailyUserId(userId)`: 日替わりIDを生成
- `getAnonymousName(dailyId, isElite)`: 匿名名を生成

### セキュリティ
- `SECRET_SALT`環境変数を使用してID生成のセキュリティを確保
- ソースコードが公開されても特定できないよう、環境変数で管理

### データ管理
- クールダウン情報はメモリ上で管理（`anonymousCooldowns` Map）
- 使用回数は日付ごとにリセット（`anonymousUsageCounts` Map）

## 関連コマンド

### `/anonymous_resolve`
- 管理者専用コマンド
- 匿名メッセージのIDまたはWacchoiからユーザーを特定

## 設定ファイル

### constants.js
- `ANONYMOUS_COOLDOWN_MS`: 基本クールダウン時間（20秒）
- `ANONYMOUS_COOLDOWN_TIERS`: 段階的クールダウン設定
- `ANONYMOUS_NAMING_PREFIXES`: 通常ユーザー用プレフィックス
- `ANONYMOUS_NAMING_SUFFIXES`: 通常ユーザー用サフィックス
- `ELITE_NAMING_PREFIXES`: エリートユーザー用プレフィックス
- `ELITE_NAMING_SUFFIXES`: エリートユーザー用サフィックス

## 注意事項
- クールダウンはユーザーごとに個別に管理されます
- 使用回数は日付が変わるごとにリセットされます
- エリートロールは一時的に付与される場合があります（例：ロシアンルーレット勝利時24時間）

