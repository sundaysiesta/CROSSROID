# 自動機能詳細

## 📋 目次

1. [メッセージ送信報酬](#メッセージ送信報酬)
2. [リアクション報酬](#リアクション報酬)
3. [VC参加報酬](#vc参加報酬)
4. [銀行預金の利子計算](#銀行預金の利子計算)
5. [借金の利子計算と自動返済](#借金の利子計算と自動返済)
6. [データ永続化](#データ永続化)

---

## メッセージ送信報酬

### 概要
メインチャンネルでメッセージを送信すると、自動的にロメコインが付与されます。

### 条件
- **チャンネル**: メインチャンネル（`MAIN_CHANNEL_ID`）でのみ有効
- **除外対象**:
  - Bot
  - 被爆ロール（`RADIATION_ROLE_ID`）

### 報酬計算

#### 基本報酬
- **10コイン**

#### 夜間ボーナス
- **時間**: 6時前（JST）
- **倍率**: 1.5倍
- **計算**: 基本報酬 × 1.5 = **15コイン**

#### 返信ボーナス
- **条件**: メッセージに返信が含まれている場合
- **追加報酬**: **+5コイン**

#### 会話参加者ボーナス
- **計算式**: `1 + (参加者数 / 10)`（最大2倍）
- **対象**: 過去5分間のメッセージ送信者
- **除外**: Bot、被爆ロール
- **例**:
  - 参加者10人: 2倍（20コイン）
  - 参加者5人: 1.5倍（15コイン）
  - 参加者0人: 1倍（10コイン）

### クールダウン
- **時間**: 1分ごとに1回のみ
- **管理**: ユーザーごとにクールダウンを管理

### 計算例
```
通常時: 10コイン
夜間（6時前）: 15コイン（10 × 1.5）
返信時: 15コイン（10 + 5）
夜間 + 返信: 20コイン（15 + 5）
会話参加者10人以上: 最大2倍（20コイン → 40コイン）
```

---

## リアクション報酬

### 概要
メインチャンネルでリアクションを追加すると、自動的にロメコインが付与されます。

### 条件
- **チャンネル**: メインチャンネル（`MAIN_CHANNEL_ID`）でのみ有効
- **除外対象**:
  - Bot
  - 被爆ロール（`RADIATION_ROLE_ID`）
  - 自分自身へのリアクション（自己リアクション防止）

### 報酬
- **+5コイン**

### クールダウン
- **時間**: 1分ごとに1回のみ
- **管理**: ユーザーごと、メッセージごとにクールダウンを管理

---

## VC参加報酬

### 概要
ボイスチャンネルに参加していると、自動的にロメコインが付与されます。

### 条件
- **VC参加**: ボイスチャンネルに参加している
- **ミュート状態**: ミュート状態ではない（`selfMute`と`serverMute`が`false`）
- **参加者数**: 2人以上（1人では会話にならない）
- **除外対象**:
  - Bot
  - 被爆ロール（`RADIATION_ROLE_ID`）

### 報酬
- **10コイン/分**（固定）

### クールダウン
- **時間**: 1分ごとに1回のみ
- **管理**: ユーザーごとにクールダウンを管理

### 処理フロー
1. VCに参加する
2. Bot、被爆ロールを除外
3. ミュート状態をチェック（ミュート中は報酬なし）
4. 参加者数をカウント（2人以上必要）
5. 1分ごとにインターバルを設定
6. 1分ごとに報酬を付与（10コイン）
7. VCから退出するとインターバルをクリア

**注意**: VCから退出すると報酬は停止します。再度参加すると新しいインターバルが開始されます。

---

## 銀行預金の利子計算

### 概要
銀行に預金しているロメコインには、自動的に利子がつきます。

### 利子率
- **年利**: 2%相当
- **1時間ごと**: 約0.000228%

### 計算式
```
利子 = 元本 × (1 + 利子率)^時間数 - 元本
```

### 計算タイミング
- **預金時**: 預金するたびに利子を計算
- **引き出し時**: 引き出しするたびに利子を計算
- **ランキング表示時**: ランキング表示時に利子を計算

### 計算例
- 預金額: 10,000コイン
- 1時間後の利子: 約2.28コイン
- 24時間後の利子: 約54.72コイン
- 1週間後の利子: 約383.04コイン

---

## 借金の利子計算と自動返済

### 概要
借金には利子がつき、期限切れになると自動的に返済処理が実行されます。

### 利子率
- **1時間ごと**: 1.5%

### 計算式
```
利子 = 元本 × (1 + 利子率)^時間数 - 元本
```

### 計算タイミング
- **借金情報確認時**: `/loan info`で確認するたびに利子を計算
- **返済時**: 返済するたびに利子を計算

### 自動返済処理

**処理タイミング**: 1時間ごと

**処理内容**:
1. すべての借金をチェック
2. 返済期限を過ぎた借金を検出
3. 借り手のロメコイン残高から返済額を減額
4. 貸し手のロメコイン残高に返済額を増額
5. 借金データを削除

**注意**: 残高が不足している場合でも強制的に返済処理が実行されます（預金から自動引き出しが使用される場合があります）。

### 計算例
- 借金額: 10,000コイン
- 1時間後の利子: 150コイン
- 24時間後の利子: 約3,600コイン
- 1週間後の利子: 約25,200コイン

**注意**: 借金の利子は非常に高く、早期返済を推奨します。

---

## データ永続化

### 自動保存

**保存タイミング**:
- データ変更時に自動保存
- 1分ごとに`persistence.js`がデータベースチャンネルにアップロード

**保存対象ファイル**:
- `romecoin_data.json`
- `bank_data.json`
- `loan_data.json`
- `daily_data.json`
- `duel_data.json`
- `janken_data.json`
- `shop_data.json`
- `mahjong_data.json`
- `activity_data.json`
- `club_investment_data.json`
- `parimutuel_data.json`
- `custom_cooldowns.json`

### バックアップ

**バックアップファイル**:
- `romecoin_data.json.backup`（自動生成）

**バックアップタイミング**:
- 保存時に自動生成

**復元**:
- メインファイルが空または存在しない場合、バックアップから自動復元

### データベースチャンネル

**アップロード**:
- 1分ごとにすべてのデータファイルをデータベースチャンネルにアップロード
- Discordの10ファイル制限を考慮して、複数のメッセージに分割

**復元**:
- `/admin_restore_file`コマンドで手動復元可能
- データベースチャンネルから最新のファイルを取得

---

## 関連ドキュメント

- [COMMANDS_OVERVIEW.md](./COMMANDS_OVERVIEW.md) - コマンド一覧
- [ROMECOIN_SYSTEM.md](./ROMECOIN_SYSTEM.md) - ロメコインシステムの詳細
- [BANK_AND_LOAN_SYSTEM.md](./BANK_AND_LOAN_SYSTEM.md) - 銀行・借金機能の詳細

