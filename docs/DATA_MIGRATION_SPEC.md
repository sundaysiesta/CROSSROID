# データ引き継ぎ仕様書

## 📊 現在保存されているデータファイル一覧

### 1. **romecoin_data.json** - ロメコインデータ
- **内容**: ユーザーのロメコイン残高
- **Notion連携**: ✅ 対応済み
- **引き継ぎ**: ✅ 対応済み

### 2. **bank_data.json** - 銀行データ
- **内容**: 銀行への預金額、最終利子計算時刻
- **Notion連携**: ✅ 対応済み
- **引き継ぎ**: ✅ 対応済み

### 3. **loan_data.json** - 借金データ
- **内容**: 借金情報（貸し手、借り手、元金、利子、返済期限など）
- **Notion連携**: ✅ 対応済み（特殊処理：貸し手と借り手の両方のNotion名を使用）
- **引き継ぎ**: ✅ 対応済み

### 4. **daily_data.json** - ログインデータ
- **内容**: 最終ログイン日、通算ログイン日数、連続ログイン日数
- **Notion連携**: ✅ 対応済み
- **引き継ぎ**: ✅ 対応済み

### 5. **duel_data.json** - デュエルデータ
- **内容**: デュエル勝利数、敗北数、連勝数、最大連勝数
- **Notion連携**: ⚠️ 未対応（引き継ぎのみ対応）
- **引き継ぎ**: ✅ 対応済み

### 6. **janken_data.json** - じゃんけんデータ
- **内容**: じゃんけんの勝敗データ
- **Notion連携**: ⚠️ 未対応（引き継ぎのみ対応）
- **引き継ぎ**: ✅ 対応済み

### 7. **shop_data.json** - ショップデータ
- **内容**: ショップでの購入履歴
- **保存場所**: `data/shop_data.json`
- **Notion連携**: ⚠️ 未対応（引き継ぎのみ対応）
- **引き継ぎ**: ✅ 対応済み

### 8. **mahjong_data.json** - 麻雀データ
- **内容**: 賭け麻雀のテーブル情報、試合結果
- **Notion連携**: ⚠️ 未対応（引き継ぎのみ対応）
- **引き継ぎ**: ✅ 対応済み

### 9. **activity_data.json** - アクティビティデータ
- **内容**: ユーザーのアクティビティ情報
- **Notion連携**: ⚠️ 未対応（引き継ぎのみ対応）
- **引き継ぎ**: ✅ 対応済み

### 10. **custom_cooldowns.json** - クールダウンデータ
- **内容**: カスタムクールダウン情報（`battle_`プレフィックス付き）
- **Notion連携**: ⚠️ 未対応（引き継ぎのみ対応、プレフィックス付き）
- **引き継ぎ**: ✅ 対応済み

---

## 🔄 データ引き継ぎAPI

### エンドポイント
```
POST /api/migrate/:userId
```

### 認証
- ヘッダー: `x-api-token: your_api_token_here`

### 引き継ぎ対象データ
1. ✅ ロメコインデータ
2. ✅ 銀行データ
3. ✅ ログインデータ
4. ✅ 借金データ
5. ✅ デュエルデータ（勝利数、敗北数、連勝数など）
6. ✅ じゃんけんデータ
7. ✅ ショップデータ
8. ✅ 麻雀データ
9. ✅ アクティビティデータ
10. ✅ クールダウンデータ

### レスポンス例
```json
{
  "success": true,
  "userId": "123456789012345678",
  "results": {
    "romecoin": "migrated",
    "bank": "migrated",
    "daily": "migrated",
    "loan": "migrated",
    "duel": "migrated",
    "janken": "migrated",
    "shop": "migrated",
    "mahjong": "migrated",
    "activity": "migrated",
    "custom_cooldowns": "migrated"
  }
}
```

---

## 📝 Notion連携の状態

### 完全対応（読み書き時に自動移行）
- ✅ ロメコインデータ
- ✅ 銀行データ
- ✅ ログインデータ
- ✅ 借金データ（特殊処理）

### 引き継ぎのみ対応（API経由で移行）
- ⚠️ デュエルデータ
- ⚠️ じゃんけんデータ
- ⚠️ ショップデータ
- ⚠️ 麻雀データ
- ⚠️ アクティビティデータ
- ⚠️ クールダウンデータ

---

## 🔧 使用方法

### ヒサメbotの`/link`コマンド実行時

ヒサメbotの`/link`コマンド実行時に、以下のAPIを呼び出してください：

```http
POST /api/migrate/:userId
Headers:
  x-api-token: your_api_token_here
```

これにより、NotionのDiscordユーザーIDプロパティが更新された際に、**すべてのデータ**が自動的にNotion名ベースに引き継がれます。

---

## ⚠️ 注意事項

1. **借金データ**: 貸し手と借り手の両方がNotionに登録されている場合のみ、完全にNotion名ベースになります
2. **既存データ**: 初回アクセス時に自動的にNotion名ベースに移行されますが、API経由で一括移行することも可能です
3. **データベース保存**: すべてのデータファイルは`persistence.js`により、Discordチャンネル（データベース）にも保存されます

