# ロメコインシステム詳細

## 📋 目次

1. [概要](#概要)
2. [ロメコインの獲得方法](#ロメコインの獲得方法)
3. [ロメコインの使用用途](#ロメコインの使用用途)
4. [コマンド一覧](#コマンド一覧)
5. [自動報酬システム](#自動報酬システム)
6. [データ管理](#データ管理)
7. [ランキングシステム](#ランキングシステム)

---

## 概要

ロメコインは、CROSSROIDサーバー内で使用できる仮想通貨です。様々な活動を通じて獲得でき、ゲーム、ショップ、投資などに使用できます。

**ロメコイン絵文字**: `<:romecoin2:1452874868415791236>`

---

## ロメコインの獲得方法

### 1. メッセージ送信報酬

**条件**:
- メインチャンネル（`MAIN_CHANNEL_ID`）でのみ有効
- Botは除外
- 被爆ロール（`RADIATION_ROLE_ID`）は除外

**報酬**:
- 基本報酬: **10コイン**
- 夜間ボーナス（6時前 JST）: **1.5倍**（15コイン）
- 返信ボーナス: **+5コイン**（返信した場合のみ）

**クールダウン**: 1分ごとに1回のみ

**会話参加者ボーナス**:
- 過去5分間のメッセージ送信者をカウント
- ボーナス倍率: `1 + (参加者数 / 10)`（最大2倍）
- Botと被爆ロールは除外

**計算例**:
- 通常時: 10コイン
- 夜間（6時前）: 15コイン（10 × 1.5）
- 返信時: 15コイン（10 + 5）
- 夜間 + 返信: 20コイン（15 + 5）
- 会話参加者10人以上: 最大2倍（20コイン → 40コイン）

---

### 2. リアクション報酬

**条件**:
- メインチャンネル（`MAIN_CHANNEL_ID`）でのみ有効
- 自分自身へのリアクションは除外
- Botは除外
- 被爆ロール（`RADIATION_ROLE_ID`）は除外

**報酬**: **+5コイン**

**クールダウン**: 1分ごとに1回のみ

---

### 3. VC（ボイスチャンネル）参加報酬

**条件**:
- VCに参加している
- ミュート状態ではない（`selfMute`と`serverMute`が`false`）
- Botは除外
- 被爆ロール（`RADIATION_ROLE_ID`）は除外
- 参加者数が2人以上（1人では会話にならない）

**報酬**: **10コイン/分**（固定）

**クールダウン**: 1分ごとに1回のみ

**注意**: VCから退出すると報酬は停止します。

---

### 4. デイリーログインボーナス

**コマンド**: `/daily`

**報酬**:
- 基本報酬:
  - 一般ユーザー: **500コイン**
  - サーバーブースター: **1,000コイン**
- 連続ログインボーナス:
  - 3日以上: **+100コイン**
  - 7日以上: **+200コイン**
  - 14日以上: **+300コイン**
  - 30日以上: **+500コイン**

**制限**:
- 世代ロール必須
- 1日1回まで

---

### 5. ゲーム報酬

#### 決闘（`/duel`）
- **勝利**: 賭け金の全額を獲得
- **敗北**: 賭け金を失う

#### ロシアンルーレット（`/duel_russian`）
- **勝利**: 賭け金の全額を獲得
- **敗北**: 賭け金を失う

#### じゃんけん（`/janken`）
- **勝利**: 賭け金の全額を獲得
- **敗北**: 賭け金を失う
- **あいこ**: 返金

#### 麻雀（`/mahjong_create`）
- 点数にレートを掛けた金額がロメコインで決済される
- プラス点数のプレイヤーは獲得、マイナス点数のプレイヤーは支払い

---

### 6. パリミュチュエル（`/race bet`）
- レースの結果に応じて配当が支払われる
- オッズは動的に計算される（パリミュチュエル方式）

---

### 7. 銀行預金の利子

**コマンド**: `/bank deposit`

**利子率**: 年利2%相当（1時間ごとに約0.000228%）

**計算式**: `利子 = 元本 × (1 + 利子率)^時間数 - 元本`

**注意**: 利子は1時間ごとに計算され、預金額に反映されます。

---

### 8. 部活投資の配当

**コマンド**: `/club_invest buy`

部活のアクティビティポイントに応じて株価が変動し、売却時に利益が発生する可能性があります。

---

### 9. 管理者による付与

**コマンド**: `/admin_romecoin_add`（管理者専用）

月間ランキング報酬、人気者選手権報酬など、運営が手動で付与する場合があります。

---

## ロメコインの使用用途

### 1. ゲーム
- 決闘（`/duel`）
- ロシアンルーレット（`/duel_russian`）
- じゃんけん（`/janken`）
- 麻雀（`/mahjong_create`）
- パリミュチュエル（`/race bet`）

### 2. ショップ
- ログ閲覧権限ロール: **25,000コイン**
- 絵文字作成権ロール: **30,000コイン**

### 3. 譲渡
- `/give`コマンドで他のユーザーに譲渡可能
- 世代ロール必須

### 4. 銀行預金
- `/bank deposit`で預金可能
- 利子がつく（年利2%相当）

### 5. 部活投資
- `/club_invest buy`で部活に投資可能
- 株価の変動により利益が発生する可能性

---

## コマンド一覧

### `/romecoin`
**説明**: ロメコインの所持数を確認します

**オプション**:
- `user` (任意): 確認したいユーザー（未指定時は自分）

**表示内容**:
- 所持ロメコイン
- 預金額（銀行に預けている場合）
- 合計残高

---

### `/romecoin_ranking`
**説明**: ロメコインランキングを確認します

**機能**:
- 預金を含めた合計残高でランキング表示
- ページネーション対応（1ページ10名）
- 「前へ」「次へ」ボタンでページ切り替え

**表示内容**:
- 順位（1-3位はメダル表示）
- ユーザー名（Notion名またはメンション）
- ロメコイン残高（預金込み）

**キャッシュ**: ランキングデータは10分間キャッシュされます。

---

### `/give`
**説明**: ロメコインを他のユーザーに譲渡します

**オプション**:
- `user` (必須): ロメコインを受け取るユーザー
- `amount` (必須): 譲渡するロメコインの量

**制限**:
- 世代ロール必須
- 自分自身への譲渡不可
- Botへの譲渡不可
- 残高が不足している場合はエラー

**手数料**: なし（以前は1%の手数料があったが削除済み）

---

### `/daily`
**説明**: デイリーログインボーナスを受け取ります

**報酬**: 上記「ロメコインの獲得方法」を参照

**制限**:
- 世代ロール必須
- 1日1回まで

---

## 自動報酬システム

### メッセージ報酬の詳細

**実装場所**: `features/romecoin.js` の `messageCreate` 関数

**処理フロー**:
1. メッセージが送信される
2. メインチャンネルかチェック
3. Bot、被爆ロールを除外
4. クールダウンをチェック（1分）
5. 基本報酬を計算（10コイン）
6. 夜間ボーナスを適用（6時前は1.5倍）
7. 返信ボーナスを適用（+5コイン）
8. 会話参加者ボーナスを計算（過去5分間の参加者数）
9. 最終報酬を計算
10. `updateRomecoin`で残高を更新
11. ログを送信（`ROMECOIN_LOG_CHANNEL_ID`）

---

### リアクション報酬の詳細

**実装場所**: `features/romecoin.js` の `messageReactionAdd` 関数

**処理フロー**:
1. リアクションが追加される
2. メインチャンネルかチェック
3. 自分自身へのリアクションを除外
4. Bot、被爆ロールを除外
5. クールダウンをチェック（1分）
6. 報酬を付与（+5コイン）
7. `updateRomecoin`で残高を更新
8. ログを送信

---

### VC参加報酬の詳細

**実装場所**: `features/romecoin.js` の `handleVoiceStateUpdate` 関数

**処理フロー**:
1. VCに参加する
2. Bot、被爆ロールを除外
3. ミュート状態をチェック（ミュート中は報酬なし）
4. 参加者数をカウント（2人以上必要）
5. 1分ごとにインターバルを設定
6. 1分ごとに報酬を付与（10コイン）
7. VCから退出するとインターバルをクリア

**注意**: VCから退出すると報酬は停止します。再度参加すると新しいインターバルが開始されます。

---

## データ管理

### データファイル

**ファイル名**: `romecoin_data.json`

**場所**: プロジェクトルート

**バックアップ**: `romecoin_data.json.backup`（自動生成）

**データ構造**:
```json
{
  "userId": 残高（数値）,
  "notionName": 残高（数値）
}
```

**Notion連携**: Discord IDとNotion名の両方で管理可能。データ移行時は`/data_migrate`コマンドを使用。

---

### データ永続化

**自動保存**:
- データ変更時に自動保存
- 1分ごとに`persistence.js`がデータベースチャンネルにアップロード

**バックアップ**:
- 保存時に`romecoin_data.json.backup`を作成
- メインファイルが空または存在しない場合、バックアップから自動復元

**復元**:
- `/admin_restore_file`コマンドで手動復元可能
- データベースチャンネルから最新のファイルを取得

---

### ログシステム

**ログチャンネル**: `ROMECOIN_LOG_CHANNEL_ID`

**ログ内容**:
- ユーザーID
- 変更前の残高
- 変更後の残高
- 変更理由
- メタデータ（コマンド名、対象ユーザーなど）

**ログ形式**:
```
[ロメコイン変更]
ユーザー: <@userId>
変更前: 10,000コイン
変更後: 10,010コイン
理由: メッセージ送信報酬
```

---

## ランキングシステム

### ランキング計算

**合計残高**: 所持ロメコイン + 預金額

**表示順**: 合計残高の降順

**除外対象**:
- Bot
- 残高が0以下のユーザー

**表示形式**:
- 1-3位: メダル表示（🥇🥈🥉）
- 4位以降: 数字表示

---

### ページネーション

**1ページあたり**: 10名

**ボタン**:
- 「前へ」: 前のページに移動
- 「次へ」: 次のページに移動

**キャッシュ**:
- ランキングデータは10分間キャッシュ
- 10分以上経過したキャッシュは自動削除

---

## 関連ドキュメント

- [COMMANDS_OVERVIEW.md](./COMMANDS_OVERVIEW.md) - コマンド一覧
- [GAME_COMMANDS.md](./GAME_COMMANDS.md) - ゲーム機能の詳細
- [BANK_AND_LOAN_SYSTEM.md](./BANK_AND_LOAN_SYSTEM.md) - 銀行・借金機能の詳細
- [SHOP_SYSTEM.md](./SHOP_SYSTEM.md) - ショップ機能の詳細
- [PARIMUTUEL_SYSTEM.md](./PARIMUTUEL_SYSTEM.md) - パリミュチュエル機能の詳細
- [FEES_AND_TAXES.md](./FEES_AND_TAXES.md) - 手数料と税の詳細

