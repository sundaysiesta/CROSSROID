# 部活システム実装指示書

## 📋 概要

使われない部活が量産されている現状を改善するため、部活ランキングTOP5の部長に賞金を支払うシステムを実装します。
週1回の部活ランキング更新時に、部長から維持費を自動徴収し、TOP5の部長に賞金を支払います。

---

## 💰 経済設定

### 部活作成費
- **初回作成費: 10,000ロメコイン**
- 部活チャンネル作成時に部長から徴収

### 週間維持費
- **週間維持費: 3,000ロメコイン**
- 部長が1人で支払い
- 話していれば稼げる金額（30位までのユーザーの週間獲得量の0.15-0.2倍）

### 部活ランキングTOP5賞金（週間、部長に支払い）

| 順位 | 賞金額 | 実質収益（維持費3,000を差し引いた後） |
|:---|:---|:---|
| **1位** | **10,000コイン** | **+7,000コイン** |
| **2位** | **9,000コイン** | **+6,000コイン** |
| **3位** | **8,000コイン** | **+5,000コイン** |
| **4位** | **7,000コイン** | **+4,000コイン** |
| **5位** | **6,000コイン** | **+3,000コイン** |

**合計賞金額: 40,000コイン/週**

**設定値（確定）:**
- 部活作成費: 10,000コイン
- 週間維持費: 3,000コイン
- 部活人気賞金: 1位10,000、2位9,000、3位8,000、4位7,000、5位6,000コイン

---

## 🔄 自動処理システム

### 処理タイミング
- **週1回、部活ランキングソート時に自動実行**
- ランキング更新のタイミングで維持費徴収と賞金支払いを同時に実行

### 処理フロー

```
1. 部活ランキングの計算
   ├─ 各部活チャンネルのメッセージ数やアクティビティを集計
   └─ ランキングTOP5を決定

2. 各部活の部長を確認
   ├─ 部長不在（部長ロールなし、退会など） → 即廃部
   └─ 部長存在 → 次のステップへ

3. 部長のロメコイン残高を確認
   ├─ 残高が3,000コイン未満 → 即廃部
   └─ 残高が3,000コイン以上 → 次のステップへ

4. 維持費の自動徴収
   └─ 各部活の部長から週間維持費（3,000コイン）を徴収

5. TOP5賞金の支払い
   ├─ ランキング1-5位の部長に賞金を支払い
   └─ 賞金額は維持費徴収後に加算

6. 廃部処理
   └─ 廃部判定された部活のチャンネルをアーカイブまたは削除
```

---

## ⚠️ 廃部条件

以下の条件に該当する部活は**即座に廃部**とします：

1. **部長不在**
   - 部長ロールが設定されていない
   - 部長がサーバーから退会している
   - 部長アカウントが削除されている

2. **維持費未払い**
   - 部長のロメコイン残高が維持費（3,000コイン）未満

### 廃部時の処理
- 部活チャンネルをアーカイブまたは削除
- 部活メンバーへの通知（必要に応じて）

---

## 📊 部活ランキングの算出方法

部活ランキングは以下の要素を考慮して算出してください：

1. **部活チャンネルのメッセージ数**（主要指標）
2. **部活チャンネルのアクティビティ**（最終メッセージからの経過時間など）
3. **部活メンバー数**（補助指標）

**推奨:** メッセージ数を主要指標とし、アクティビティを補助指標として使用

---

## 💻 実装時の設定値

```javascript
const CLUB_SYSTEM_CONFIG = {
    // 部活作成費
    creationFee: 10000,  // 初回作成費（ロメコイン）
    
    // 週間維持費（部長が1人で支払い）
    weeklyMaintenance: 3000,  // 週間維持費（ロメコイン）
    
    // 部活ランキングTOP5賞金（週間、部長に支払い）
    rankingRewards: {
        1: 10000,  // 1位の賞金
        2: 9000,   // 2位の賞金
        3: 8000,   // 3位の賞金
        4: 7000,   // 4位の賞金
        5: 6000    // 5位の賞金
    },
    
    // 廃部条件
    disbandConditions: {
        noLeader: true,        // 部長不在で即廃部
        insufficientFunds: true // 維持費未払い（3,000コイン未満）で即廃部
    },
    
    // ロメコインAPI
    romecoinAPI: {
        baseURL: 'http://localhost:3000',  // CROSSROIDのAPIエンドポイント
        endpoints: {
            getBalance: '/api/romecoin/:userId',      // 残高取得
            deduct: '/api/romecoin/:userId/deduct'    // 減額
        },
        apiToken: process.env.API_TOKEN  // API認証トークン
    }
};
```

---

## 🔌 API連携

### ロメコイン残高の取得

```javascript
// GET /api/romecoin/:userId
// ヘッダー: x-api-token: {API_TOKEN}
// レスポンス: { userId: string, balance: number }
```

### ロメコインの減額（維持費徴収）

```javascript
// POST /api/romecoin/:userId/deduct
// ヘッダー: x-api-token: {API_TOKEN}
// ボディ: { amount: number }
// レスポンス: { 
//   success: boolean,
//   userId: string,
//   deducted: number,
//   previousBalance: number,
//   newBalance: number
// }
```

### ロメコインの追加（賞金支払い）

```javascript
// 賞金支払い用のAPIエンドポイントが必要な場合
// または、CROSSROID側で実装が必要
// 現状は updateRomecoin 関数を使用
```

---

## 📝 実装時の注意点

1. **エラーハンドリング**
   - API呼び出し失敗時の処理
   - 部長のロメコイン残高が不足している場合の処理
   - ネットワークエラー時のリトライ処理

2. **ログ記録**
   - 維持費徴収の記録
   - 賞金支払いの記録
   - 廃部処理の記録

3. **通知機能**
   - 維持費徴収時の部長への通知
   - 賞金支払い時の部長への通知
   - 廃部時の部活メンバーへの通知

4. **トランザクション処理**
   - 維持費徴収と賞金支払いの整合性を保つ
   - エラー発生時のロールバック処理

5. **パフォーマンス**
   - 部活数が多い場合の処理時間を考慮
   - ランキング計算の最適化

---

## 🎯 期待される効果

1. **使われない部活の自然淘汰**
   - 維持費を支払えない非アクティブな部活が自動的に廃部
   - 部活チャンネルの乱立を防止

2. **人気部活の部長への報酬**
   - TOP5に入ることで維持費以上の収益
   - 部活運営のモチベーション向上

3. **経済循環の促進**
   - 維持費徴収と賞金支払いによるロメコインの循環
   - アクティブな部活へのインセンティブ

---

## 📞 連絡事項

- 実装時の質問や問題があれば、CROSSROID開発者に連絡
- API仕様の変更がある場合は、事前に確認すること
- テスト環境での動作確認を十分に行うこと

